# Сокращение URL

## Описание задачи
Сервис обрабатывает запрос пользователя с длинной ссылкой. В ответе
сервис возвращает короткую ссылку. При переходе по короткой ссылке в
браузере должна открываться страница по длинной ссылке.

## Stack

>Language: __Python 3__<br>
Web framework: __FastAPI__<br>
Database: __PostgreSQL__<br>

Другое: Docker, SQLAlchemy, pytest, Kubernetes, Grafana

## API Views

><p>/api/short — возвращает короткую ссылку по длинной, добавляет в базу данных, если ее не было (CREATE), иначе возвращает уже существующюю (GET);<br></p>
><p>/short/{link_id} — перенаправляет по короткой ссылке;<br></p>
><p>/api/short/delete — удаляет ссылку по длинной (DELETE);<br></p>

## Информация о доступе к документации OpenAPI (Swagger)
> - <p>/docs/ — Документация;<br>
## Локальный запуск
### I. Инструкции для локального развертывания
1. Клонируйте репозиторий:
```
git clone git@gitlab.com:shift-python/y2023/homeworks/doncov-a/link-shortener.git
```
2. Перейдите в директорию проекта, активируйте виртуальное окружение:
```
poetry shell
```
```
poetry install
```
3. Заполните .env файл, по примеру .env_example:
4. Накатите миграции:
```
alembic -c src/alembic.ini upgrade c87d9b994a3c
```
5. Запустите сервис:
```
python -m src.app.service
```
### II. Инструкции для локального запуска тестов
1. Запустите тесты:
```
pytest --cov
```
### III. Инструкции для локального запуска линтера
1. Запустите линтер:
```
flake8 src/app/
```
### IV. Инструкции для локальной сборки образов
1. Соберите образ:
```
docker build -t app1 -f src/Dockerfile .
```
## Инструкции для развертывания и остановки сервиса в Kubernetes
### I. Подготовка
1. Перейдите в директорию k8s/ и примените конфигурацию секретов(они уже есть на сервере):
```
kubectl apply -f secret.yaml
```
2. Создайте тестовую и основную базы данных в postgres, для этого зайдите в под postgres, подключитесь к postgres и создайте базы данных в соответствии с секретами(уже есть на сервере).
3. Соберите и запуште образы в gitlab, измените репозитории и теги в values.yaml(тоже еще есть).
### II. Развертывание и остановка сервиса
1. Перейдите в директорию helm/ и разверните сервис:
```
helm install adontsov-link src/
```
2. Остановите сервис:
```
helm uninstall adontsov-link
```
## Сопровождение
- метрики сервиса собираются в учебном кластере prometheus и jaeger tracing;
- в сервисе собираются метрики prometheus;
- в сервисе мониторинга Grafana настроен дашборд с отображением собираемых метрик в папке adontsov/url-link.